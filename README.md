# BrothelManager

Discord-бот в жанре gacha/менеджера. Игроки собирают персонажей, выполняют задания и развивают собственный «бордель». Точка входа в проект — модуль [`src/bot.py`](src/bot.py).

## Основные slash-команды

| Команда | Категория | Краткое описание |
| --- | --- | --- |
| `/start` | Прогресс игрока | Создаёт профиль, выдаёт 500 монет и стартовую девушку из каталога. |
| `/profile` | Прогресс игрока | Показывает баланс, количество девушек, славу (renown) и уровень маркета. |
| `/gacha` | Гача | Проводит прокрутку (по умолчанию 100 монет за попытку) и добавляет девушку при свободной комнате. |
| `/market` | Экономика | Открывает рынок работ, позволяет выбрать уровень через `level:<n>` и сразу запустить выполнение. |
| `/brothel` | Управление | Отображает состояние заведения, апгрейды комфорта/гигиены/безопасности/привлекательности, уборку, рекламу и расширение комнат. |
| `/train` | Развитие | Назначает наставницу и ученицу для прокачки навыка или саб-скилла. |
| `/top` | Сообщество | Показывает топы борделей и девушек по суммарной прокачке. |
| `/heal` | Поддержка | Лечит выбранную девушку за монеты. |
| `/sync` | Администрирование | Перерегистрирует slash-команды (доступно только владельцу приложения). |
| `/invite` | Администрирование | Возвращает ссылку-приглашение бота с правами `applications.commands` и `bot`. |

## Ключевые механики

- Девушки развивают здоровье, выносливость и страсть (LUST); настроение влияет на шанс успеха, награды и риск травм.
- Статы борделя (комфорт, гигиена, безопасность, привлекательность) повышают награды, снижают травматизм и требуют регулярного обслуживания.
- Слава (`renown`) объединяет прежние «репутацию» и «популярность» и влияет на качество клиентов.
- Количество комнат ограничивает число сотрудниц; расширение покупается через `/brothel`.
- Наставничество временно блокирует работу пары, но даёт ученице повышенный опыт по выбранному фокусу.
- Комфортные условия ускоряют восстановление и удешевляют лечение сотрудниц.

## Быстрый старт

### Требования

- Python 3.10 или новее
- Discord-приложение с включёнными slash-командами

### Установка зависимостей

```bash
pip install -r requirements.txt
```

### Конфигурация

Отредактируйте `config.json` перед запуском:

- `discord.token` — токен бота;
- `discord.guild_id` — необязательный ID тестового сервера для локальной синхронизации команд;
- `paths.*` — пути к данным, каталогу девушек и локальным ассетам (по умолчанию используются каталоги в репозитории);
- `gacha.*` — стоимость прокрутки, стартовые монеты и ID стартовой девушки;
- `market.*` — частота автоматического обновления и количество доступных заданий на уровень;
- `balance.*` — настройки наград, стоимости действий и модификаторов успеха. Все параметры имеют безопасные значения по умолчанию, но их можно переопределять частично, например:

  ```json
  {
    "balance": {
      "market": {"base_pay": 60, "renown_divisor": 6}
    }
  }
  ```

  Ключевые параметры вознаграждения:

  - `balance.reward.main_rate` и `balance.reward.sub_rate` — процентный прирост базовой выплаты за каждый уровень превышения требований по основному и саб-скиллу (по умолчанию ≈0.22% и 0.14%).
  - `balance.reward.skill_ratio_cap` — минимальный и максимальный множитель бонуса за скиллы (по умолчанию 1.0–2.6).

### Запуск

```bash
python -m src.bot
```

После запуска бот зарегистрирует slash-команды и выведет ссылку-приглашение в консоль.

## Архитектура и структура проекта

### Обзор каталогов

```
BrothelManager/
├── assets/
│   └── girls/             # Локальные изображения и анимации девушек
├── data/
│   ├── girls_catalog.json # Каталог доступных персонажей и их параметров
│   ├── markets/           # Кэш рынков заданий (создаётся автоматически)
│   └── users/             # Сохранения игроков (создаётся автоматически)
├── src/
│   ├── assets_util.py     # Поиск файлов ассетов по имени/скиллам
│   ├── bot.py             # Точка входа, настройка Bot и синхронизация команд
│   ├── models.py          # Pydantic-модели и формулы прогрессии
│   ├── storage.py         # Фасад над игровыми сервисами и файловым слоем
│   ├── cogs/
│   │   ├── admin.py       # Админские slash-команды (`/sync`, `/invite`)
│   │   └── core.py        # Игровые команды, фоновые задачи и обработка действий
│   └── game/
│       ├── __init__.py    # Пакет с ленивым экспортом сервисов и презентационных модулей
│       ├── constants.py   # Эмодзи, подписи и другие константы оформления
│       ├── embeds.py      # Формирование Discord Embed для профилей и борделей
│       ├── repository.py  # `DataStore`: файловое хранилище игроков/рынков
│       ├── services.py    # `GameService`: игровая логика гачи, рынка и прогрессии
│       ├── utils.py       # Утилиты выбора опций и расчёта состояния страсти
│       └── views.py       # UI-компоненты Discord (пагинатор, рынок работ)
├── config.json            # Конфигурация бота и игровых параметров
├── requirements.txt       # Список зависимостей проекта
└── README.md              # Документация
```

### Ключевые модули

| Путь | Назначение | Основные элементы |
| --- | --- | --- |
| `src/bot.py` | Собирает `commands.Bot`, загружает коги и синхронизирует slash-команды. | `load_config()`, `main()`, `setup_hook` с загрузкой `core` и `admin`. |
| `src/cogs/core.py` | Главный ког с игровыми slash-командами, листингами и обработкой заданий. | Класс `Core`, фоновая задача `market_refresher`, генерация Embed и UI. |
| `src/cogs/admin.py` | Администрирование бота. | Класс `Admin`, команды `/sync` и `/invite`. |
| `src/models.py` | Доменные сущности и формулы роста. | Классы `Player`, `Girl`, `BrothelState`, утилиты опыта (`make_bar`, `skill_xp_threshold`). |
| `src/storage.py` | Адаптер между старыми вызовами и новой архитектурой. | Глобальные экземпляры `DataStore`/`GameService`, функции `load_player`, `roll_gacha`, `brothel_leaderboard`. |
| `src/game/repository.py` | Работа с файловой структурой данных. | Класс `DataStore`, методы `user_path()`, `iter_user_ids()`, `load_catalog()`. |
| `src/game/balance.py` | Центральные параметры баланса. | Датаклассы весов, загрузка настроек из `config.json`. |
| `src/game/services.py` | Основная игровая логика и правила. | Класс `GameService`, методы генерации гачи, рынка, расчёта наград и наставничества. |
| `src/game/embeds.py` | Представление данных в Discord. | Функции `build_brothel_embed`, `build_girl_embed`, `brothel_facility_lines`. |
| `src/game/views.py` | Интерактивные Discord View. | `Paginator`, `MarketWorkView` с обработкой выбора девушек и заданий. |
| `src/assets_util.py` | Определение путей до локальных изображений. | `profile_image_path()`, `action_image_path()`, `pregnant_profile_image_path()`. |

### Разработка

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

- Для проверки логики используйте `pytest` из корня репозитория.
- Конфигурацию и тестовые данные храните отдельно, не добавляйте приватные токены в Git.
- Перед открытием PR убедитесь, что бот запускается командой `python -m src.bot` и проходят доступные автотесты.

## Данные и ассеты

- `data/girls_catalog.json` содержит описание базовых параметров девушек (редкость, навыки, биографию, предпочтения).
- Каталоги `data/users/` и `data/markets/` создаются автоматически и служат для хранения сохранений и актуальных заданий.
- `assets/girls/` используется `assets_util.py` и `game.embeds` для подстановки локальных изображений вместо удалённых ссылок.

## Лицензия

Проект распространяется под лицензией MIT. Полный текст хранится в файле `LICENSE` (добавьте при необходимости).
