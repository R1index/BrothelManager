# BrothelManager

Discord-бот в жанре gacha/менеджера. Игроки собирают персонажей, выполняют задания и развивают собственный «бордель». Точка входа в проект — модуль [`src/bot.py`](src/bot.py).

## Основные slash-команды

| Команда | Категория | Краткое описание |
| --- | --- | --- |
| `/start` | Прогресс игрока | Создаёт профиль, выдаёт 500 монет и стартовую девушку из каталога. |
| `/profile` | Прогресс игрока | Показывает баланс, количество девушек, славу (renown) и уровень маркета. |
| `/gacha` | Гача | Проводит прокрутку (по умолчанию 100 монет за попытку) и добавляет девушку при свободной комнате. |
| `/market` | Экономика | Открывает рынок работ, позволяет выбрать уровень через `level:<n>` и сразу запустить выполнение. |
| `/brothel` | Управление | Отображает состояние заведения, апгрейды комфорта/гигиены/безопасности/привлекательности, уборку, рекламу и расширение комнат. |
| `/train` | Развитие | Назначает наставницу и ученицу для прокачки навыка или саб-скилла. |
| `/top` | Сообщество | Показывает топы борделей и девушек по суммарной прокачке. |
| `/heal` | Поддержка | Лечит выбранную девушку за монеты. |
| `/sync` | Администрирование | Перерегистрирует slash-команды (доступно только владельцу приложения). |
| `/invite` | Администрирование | Возвращает ссылку-приглашение бота с правами `applications.commands` и `bot`. |

## Ключевые механики

- Девушки развивают здоровье, выносливость и страсть (LUST); настроение влияет на шанс успеха, награды и риск травм.
- Статы борделя (комфорт, гигиена, безопасность, привлекательность) повышают награды, снижают травматизм и требуют регулярного обслуживания.
- Слава (`renown`) объединяет прежние «репутацию» и «популярность» и влияет на качество клиентов.
- Количество комнат ограничивает число сотрудниц; расширение покупается через `/brothel`.
- Наставничество временно блокирует работу пары, но даёт ученице повышенный опыт по выбранному фокусу.
- Комфортные условия ускоряют восстановление и удешевляют лечение сотрудниц.

## Быстрый старт

### Требования

- Python 3.10 или новее
- Discord-приложение с включёнными slash-командами

### Установка зависимостей

```bash
pip install -r requirements.txt
```

### Конфигурация

Отредактируйте `config.json` перед запуском:

- `discord.token` — токен бота;
- `discord.guild_id` — необязательный ID тестового сервера для локальной синхронизации команд;
- `paths.*` — пути к данным, каталогу девушек и локальным ассетам (по умолчанию используются каталоги в репозитории);
- `gacha.*` — стоимость прокрутки, стартовые монеты и ID стартовой девушки;
- `market.*` — частота автоматического обновления и количество доступных заданий на уровень;
- `balance.*` — настройки наград, стоимости действий и модификаторов успеха. Все параметры имеют безопасные значения по умолчанию, но их можно переопределять частично, например:

  ```json
  {
    "balance": {
      "market": {"base_pay": 60, "renown_divisor": 6}
    }
  }
  ```

  Ключевые параметры вознаграждения:

  - `balance.reward.main_rate` и `balance.reward.sub_rate` — процентный прирост базовой выплаты за каждый уровень превышения требований по основному и саб-скиллу (по умолчанию ≈0.22% и 0.14%).
  - `balance.reward.skill_ratio_cap` — минимальный и максимальный множитель бонуса за скиллы (по умолчанию 1.0–2.6).

### Запуск

```bash
python -m src.bot
```

После запуска бот зарегистрирует slash-команды и выведет ссылку-приглашение в консоль.

## Архитектура и структура проекта

### Обзор каталогов

```
BrothelManager/
├── assets/
│   └── girls/             # Локальные изображения и анимации девушек
├── data/
│   ├── girls_catalog.json # Каталог доступных персонажей и их параметров
│   ├── markets/           # Кэш рынков заданий (создаётся автоматически)
│   └── users/             # Сохранения игроков (создаётся автоматически)
├── src/
│   ├── assets_util.py     # Поиск файлов ассетов по имени/скиллам
│   ├── bot.py             # Точка входа, настройка Bot и синхронизация команд
│   ├── models.py          # Pydantic-модели и формулы прогрессии
│   ├── storage.py         # Фасад над игровыми сервисами и файловым слоем
│   ├── cogs/
│   │   ├── admin.py       # Админские slash-команды (`/sync`, `/invite`)
│   │   └── core.py        # Игровые команды, фоновые задачи и обработка действий
│   └── game/
│       ├── __init__.py    # Пакет с ленивым экспортом сервисов и презентационных модулей
│       ├── balance.py     # Параметры баланса и утилиты мерджа с config.json
│       ├── constants.py   # Эмодзи, подписи и другие константы оформления
│       ├── embeds.py      # Формирование Discord Embed для профилей и борделей
│       ├── repository.py  # `DataStore`: файловое хранилище игроков/рынков
│       ├── services.py    # `GameService`: игровая логика гачи, рынка и прогрессии
│       ├── utils.py       # Утилиты выбора опций и расчёта состояния страсти
│       └── views.py       # UI-компоненты Discord (пагинатор, рынок работ)
├── tests/                 # Набор pytest-тестов для проверки ключевых сценариев
├── config.json            # Конфигурация бота и игровых параметров
├── requirements.txt       # Список зависимостей проекта
└── README.md              # Документация
```

### Ключевые модули

| Путь | Назначение | Основные элементы |
| --- | --- | --- |
| `src/bot.py` | Собирает `commands.Bot`, загружает коги и синхронизирует slash-команды. | `load_config()`, `main()`, обработчик `on_ready`, `setup_hook` с регистрацией команд и выводом ссылки-приглашения. |
| `src/cogs/core.py` | Главный ког с игровыми slash-командами, листингами и обработкой заданий. | Класс `Core`, фоновые задачи (`market_refresher`), генерация Embed, показ топов через `TopLeaderboardView`, запуск `MarketWorkView`. |
| `src/cogs/admin.py` | Администрирование бота. | Класс `Admin`, slash-команды `/sync` и `/invite`, вспомогательный `_sync_commands()` с обработкой ошибок конфигурации. |
| `src/models.py` | Доменные сущности и формулы роста. | Классы `Girl`, `Market`, `Job`, `BrothelState`, `Player`, утилиты `regen_stamina()`, `make_bar()`, расчёт порогов опыта. |
| `src/storage.py` | Адаптер между старым интерфейсом и сервисами. | Глобальные `DataStore`/`GameService`, функции `load_player()`, `generate_market()`, `brothel_leaderboard()`, доступ к конфигу. |
| `src/game/__init__.py` | Упрощает импорты игровых сервисов и представлений. | Экспорт `GameService`, `DataStore`, ленивые модули `constants`, `utils`, `embeds`, `views`. |
| `src/game/balance.py` | Центральные параметры баланса и их переопределение конфигом. | Датаклассы `CostBalance`, `SuccessBalance`, `RewardBalance`, `InjuryBalance`, `MarketBalance`, загрузка профиля через `load_balance_profile()`. |
| `src/game/constants.py` | Константы оформления и текстовых блоков. | Наборы `EMOJI_*`, `SKILL_ICONS`, `SUB_SKILL_ICONS`, `FACILITY_INFO`, `PREF_ICONS`, разделитель `EMBED_SPACER`. |
| `src/game/repository.py` | Работа с файловой структурой данных. | Класс `DataStore`, настройка путей из конфига, чтение/запись JSON, методы `user_path()`, `iter_user_ids()`, `load_catalog()`. |
| `src/game/services.py` | Основная игровая логика и правила. | Класс `GameService`, кэширование конфигурации/баланса, методы `grant_starter_pack()`, `generate_market()`, `gather_brothel_top()`, `gather_girl_top()`. |
| `src/game/embeds.py` | Представление данных в Discord. | `build_brothel_embed()`, `build_girl_embed()`, `brothel_facility_lines()`, `format_training_lines()`, прогресс-бар статов. |
| `src/game/utils.py` | Общие утилиты и вычисления. | `choice_value()`, `lust_state_label()`, `lust_state_icon()`, `preference_icon()`. |
| `src/game/views.py` | Интерактивные Discord View. | `Paginator` с вложениями, `MarketWorkView` (выбор девушки/работы, запуск `resolve_job()`), `TopLeaderboardView` для интерактивных топов. |
| `src/assets_util.py` | Определение путей до локальных изображений. | Управление базовым каталогом (`set_assets_dir()`), `profile_image_path()`, `action_image_path()`, `pregnant_profile_image_path()`. |

#### Детализация каталога `src/`

- `bot.py`
  - Загружает конфигурацию, проверяет наличие токена и настраивает `discord.Intents` перед запуском.
  - Определяет `setup_hook()` с загрузкой когов `src.cogs.core` и `src.cogs.admin`, синхронизирует slash-команды глобально или в указанной гильдии.
  - В `on_ready()` выводит ссылку-приглашение и базовые сведения о боте.
- `assets_util.py`
  - Управляет базовым каталогом ассетов через `set_assets_dir()`/`get_assets_dir()`.
  - Формирует пути к изображениям профиля, действий и беременной версии девушек (`profile_image_path()`, `action_image_path()`, `pregnant_profile_image_path()`).
- `models.py`
  - Содержит константы навыков и предпочтений, коэффициенты редкости и утилиты восстановления (`regen_stamina()`).
  - Описывает pydantic-модели `Girl`, `BrothelState`, `Market`, `Job`, `Player` с методами нормализации (`normalize_skill_structs()`, `ensure_brothel()`).
  - Включает функции расчёта порогов опыта и прогресс-баров (`normalize_skill_map()`, `skill_xp_threshold()`, `facility_xp_threshold()`, `make_bar()`).
- `storage.py`
  - Создаёт глобальные экземпляры `DataStore` и `GameService`, предоставляя тонкий фасад для вызовов из когов.
  - Экспортирует функции загрузки/сохранения игроков и рынков (`load_player()`, `save_player()`, `refresh_market_if_stale()`), генерации заданий (`generate_market()`), получения топов (`brothel_leaderboard()`, `girl_leaderboard()`), доступа к конфигу (`get_config()`).
- `cogs/`
  - `core.py`
    - Класс `Core` регистрирует slash-команды (`/start`, `/profile`, `/gacha`, `/market`, `/brothel`, `/train`, `/heal`, `/top`, `/girls`, `/dismantle`) и запускает фоновые задачи (`market_refresher`).
    - Методы `_brothel_status_notes()`, `_build_brothel_embed()`, `_send_response()` и `_save_and_respond()` добавляют подсказки игроку и управляют ответами.
    - Интегрирует `MarketWorkView`, `TopLeaderboardView` и `Paginator` для интерактивного взаимодействия с пользователем.
  - `admin.py`
    - Slash-команды `/sync` и `/invite`, проверка владельца приложения перед синхронизацией.
    - `load_cfg()` и `_sync_commands()` читают `config.json`, поддерживают вложенный `discord.guild_id` и сообщают о причинах отката к глобальной синхронизации.
- `game/`
  - `__init__.py`
    - Экспортирует `DataStore`, `GameService` и ленивые подпакеты `constants`, `utils`, `embeds`, `views` через `__getattr__()`.
  - `balance.py`
    - Определяет `@dataclass`-структуры `CostBalance`, `SuccessBalance`, `RewardBalance`, `InjuryBalance`, `MarketBalance`.
    - Функции `_coerce_scalar()`, `_merge_dataclass()` и `load_balance_profile()` применяют частичные переопределения параметров из конфигурации.
  - `constants.py`
    - Содержит эмодзи оформления, карты иконок навыков и саб-скиллов, `FACILITY_INFO` и `PREF_ICONS`, а также пробел `EMBED_SPACER` для выравнивания Embed.
  - `embeds.py`
    - `build_brothel_embed()` и `build_girl_embed()` формируют Discord Embed с прогрессом, наградами и характеристиками.
    - Дополнительные функции (`brothel_overview_lines()`, `brothel_facility_lines()`, `format_training_lines()`, `_format_skill_lines()`) создают строки прогресса и отображают предпочтения через `preference_icon()`.
  - `repository.py`
    - Класс `DataStore` управляет путями `data/`, `users/`, `markets/`, каталога девушек и ассетов, поддерживает переопределения через `configure_paths()`.
    - Предоставляет операции `read_json()`, `write_json()`, `user_path()`, `market_path()`, `load_catalog()`, `iter_user_ids()`.
  - `services.py`
    - `GameService` кэширует конфиг и баланс, подготавливает каталоги данных, настраивает директорию ассетов.
    - Реализует выдачу стартового набора (`grant_starter_pack()`), гачу (`roll_gacha()`), генерацию и обновление рынков (`generate_market()`, `refresh_market_if_stale()`), расчёт и проведение заданий (`evaluate_job()`, `resolve_job()`).
    - Собирает лидерборды (`gather_brothel_top()`, `gather_girl_top()`), управляет наставничеством и состоянием девушек.
  - `utils.py`
    - Утилиты извлечения значений (`choice_value()`), отображения состояния страсти (`lust_state_label()`, `lust_state_icon()`), подстановки иконок предпочтений (`preference_icon()`).
  - `views.py`
    - `Paginator` листает Embed с привязкой к инициатору и поддержкой файловых вложений.
    - `MarketWorkView` управляет выбором девушки и работы, подгружает рынок (`refresh_market_if_stale()`), вызывает `resolve_job()`, сохраняет прогресс и выводит результат.
    - `TopLeaderboardView` позволяет просматривать подробности записей топа (бордели, девушки) и возвращаться к сводному Embed.

#### Тесты

- `tests/test_core.py` — проверяет основные slash-команды, корректность формирования Embed и отклика кода при ошибках валидации.
- `tests/test_gacha.py` — покрывает сценарии прокруток, расход монет и получение наград/девушек.
- `tests/test_game_service.py` — концентрируется на бизнес-логике `GameService`: рынок заданий, апгрейды и расчёт наград.
- `tests/test_models.py` — тесты pydantic-моделей и формул прогрессии (`skill_xp_threshold`, генерация прогресс-баров).
- `tests/test_views.py` — проверяет Discord View (пагинацию, выбор заданий, реакции на интеракции).

### Разработка

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

- Для проверки логики используйте `pytest` из корня репозитория.
- Конфигурацию и тестовые данные храните отдельно, не добавляйте приватные токены в Git.
- Перед открытием PR убедитесь, что бот запускается командой `python -m src.bot` и проходят доступные автотесты.

## Данные и ассеты

- `data/girls_catalog.json` содержит описание базовых параметров девушек (редкость, навыки, биографию, предпочтения).
- Каталоги `data/users/` и `data/markets/` создаются автоматически и служат для хранения сохранений и актуальных заданий.
- `assets/girls/` используется `assets_util.py` и `game.embeds` для подстановки локальных изображений вместо удалённых ссылок.

## Лицензия

Проект распространяется под лицензией MIT. Полный текст хранится в файле `LICENSE` (добавьте при необходимости).
